<view class="page">
  <!-- 内容区：根据底部导航的 tab 切换 -->
  <view class="content">

    <!-- 过去 -->
    <view tt:if="{{tab==='past'}}" class="section">
      <view class="section-title"><text class="title-dot"></text>情绪云图</view>
      <view class="cloud">
        <block tt:for="{{cloud}}" tt:key="name">
          <view class="chip cloud-chip" style="transform:scale({{item.scale}})">{{item.name}}</view>
        </block>
      </view>

      <view class="section-title" style="margin-top:18rpx;"><text class="title-dot"></text>时间线</view>
      <view class="timeline">
        <block tt:for="{{timeline}}" tt:key="id">
          <view class="card item">
            <view class="time">{{item.time}}</view>
            <view class="summary">{{item.summary}}</view>
            <view class="chips" style="margin-top:8rpx;">
              <block tt:for="{{item.topics}}" tt:key="*this">
                <view class="chip">#{{item}}</view>
              </block>
            </view>
          </view>
        </block>
      </view>
    </view>

    <!-- 今天 -->
    <view tt:elif="{{tab==='today'}}" class="section">
      <view class="section-title"><text class="title-dot"></text>今日技能卡</view>
      <scroll-view scroll-x="true" class="skills">
        <block tt:for="{{skills}}" tt:key="id">
          <view class="skill">
            <view class="skill-title">{{item.title}}</view>
            <view class="subtle">{{item.meta}}</view>
            <view class="btn-primary" style="margin-top:12rpx" data-id="{{item.id}}" bindtap="practice">练习</view>
          </view>
        </block>
      </scroll-view>

      <view class="section-title" style="margin-top:18rpx;"><text class="title-dot"></text>微行动清单</view>
      <view class="actions">
        <block tt:for="{{actions}}" tt:key="at">
          <view class="action-row">
            <view class="dot"></view>
            <text class="action-text">{{item.text}}</text>
            <text class="action-time">{{item.time}}</text>
          </view>
        </block>
      </view>
    </view>

    <!-- 未来：人物关系图谱 + 事件清单 -->
    <view tt:else class="section">
      <view class="section-title"><text class="title-dot"></text>人物关系</view>
      <view class="graph-wrap">
        <canvas canvas-id="graph" id="graph"
        style="width:100%;height:600rpx;background:#fff;border:2rpx solid #e5e7eb;border-radius:20rpx;"></canvas>
      </view>

      <view class="card detail-card">
        <view class="section-title small">
          <text class="title-dot"></text>
          {{personTitle}}
        </view>

        <!-- 人物简介 -->
        <view class="person-detail">{{personInfo}}</view>

        <!-- 事件清单 -->
        <view class="section-title small" style="margin-top:10rpx;">
          <text class="title-dot"></text>相关事件
        </view>

        <view tt:if="{{selectedEvents.length}}">
          <block tt:for="{{selectedEvents}}" tt:key="id">
            <view class="ev-row" data-id="{{item.id}}" bindtap="openEditEvent">
              <view class="ev-left">
                <view class="ev-time">{{item.time}}</view>
                <view class="ev-summary">{{item.summary}}</view>
                <view class="chips" style="margin-top:6rpx;">
                  <block tt:for="{{item.topics}}" tt:key="*this"><view class="chip">#{{item}}</view></block>
                </view>
              </view>
              <view class="ev-edit">编辑</view>
            </view>
          </block>
        </view>
        <view tt:else class="subtle">暂无事件，点击下方“新增事件”开始记录。</view>

        <view class="btn-row" style="margin-top:12rpx;">
          <view class="btn-ghost" bindtap="addEvent">新增事件</view>
        </view>
      </view>
    </view>

    <!-- 底部留白，避免被导航遮挡 -->
    <view style="height:120rpx"></view>
  </view>

  <!-- 底部导航栏 -->
  <view class="bottom-nav">
    <view class="nav-item {{tab==='past'?'on':''}}" data-tab="past" bindtap="switchTab">
      <view class="nav-ico">⏳</view><view class="nav-txt">过去</view>
    </view>
    <view class="nav-item {{tab==='today'?'on':''}}" data-tab="today" bindtap="switchTab">
      <view class="nav-ico">🌞</view><view class="nav-txt">今天</view>
    </view>
    <view class="nav-item {{tab==='future'?'on':''}}" data-tab="future" bindtap="switchTab">
      <view class="nav-ico">🔮</view><view class="nav-txt">未来</view>
    </view>
  </view>

  <!-- 事件编辑弹层 -->
  <view class="sheet {{showEditor?'show':''}}">
    <view class="inner">
      <view class="handle"></view>
      <view class="sheet-title">{{editor.isNew?'新增事件':'编辑事件'}}</view>

      <view class="form-row">
        <view class="label">时间</view>
        <input class="input" placeholder="例如：今天 09:20 / 2025-08-15 09:20"
               value="{{editor.time}}" bindinput="onEditTime"/>
      </view>

      <view class="form-row">
        <view class="label">概要</view>
        <textarea class="textarea" placeholder="一句话描述发生了什么"
                  value="{{editor.summary}}" bindinput="onEditSummary"/>
      </view>

      <view class="form-row">
        <view class="label">话题</view>
        <input class="input" placeholder="#工作 #沟通（用空格分隔，自动去重）"
               value="{{editor.topicsText}}" bindinput="onEditTopics"/>
      </view>

      <view class="btn-row">
        <view class="btn-ghost" bindtap="cancelEdit">取消</view>
        <view class="btn-primary" bindtap="saveEvent">保存</view>
        <view class="btn-danger" tt:if="{{!editor.isNew}}" bindtap="deleteEvent">删除</view>
      </view>
    </view>
  </view>
</view>
